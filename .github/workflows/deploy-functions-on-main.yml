name: Deploy functions on main

on:
  push:
    branches: [main]

jobs:
  verify-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install web deps
        run: npm ci --no-audit --no-fund

      - name: Verify web build
        run: npm run typecheck && npm run build

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: functions/package-lock.json

      - name: Install functions deps
        working-directory: functions
        run: npm ci --no-audit --no-fund

      - name: Build functions
        working-directory: functions
        run: npm run build

      - name: Deploy functions
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON != '' }}
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT_JSON" > "$RUNNER_TEMP/firebase-sa.json"
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/firebase-sa.json"
          npx firebase deploy --only functions --project mybodyscan-f3daf --non-interactive

      - name: Skip deploy (secret missing)
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON == '' }}
        run: echo "FIREBASE_SERVICE_ACCOUNT_JSON not configured; skipping deploy."
