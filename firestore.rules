rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isDemoByClaim() {
      return isSignedIn() && (request.auth.token.demo == true);
    }

    function isDemoByUid() {
      return isSignedIn() && (request.auth.uid == "DEMO_UID_REPLACE_ME");
    }

    function isDemoUser() {
      return isDemoByClaim() || isDemoByUid();
    }

    function serverOwnedKeys() {
      return ['credits', 'stripe', 'plan', 'subscription', 'role', 'claims', 'stripeCustomerId'];
    }

    function isWritingServerOwnedFields() {
      return request.resource.data.diff(resource.data).affectedKeys().hasAny(serverOwnedKeys());
    }

    function onboardingFieldKeys() {
      return ['age', 'sex', 'height', 'goal', 'timeline', 'equipment', 'injuries', 'activities', 'experience', 'diet', 'likes', 'notifications', 'completedAt', 'version'];
    }

    function isSexValue(value) {
      return value == 'male' || value == 'female' || value == 'other';
    }

    function isGoalValue(value) {
      return value == 'lose-fat' || value == 'gain-muscle' || value == 'maintain' || value == 'recomp';
    }

    function isEquipmentValue(value) {
      return value == 'gym' || value == 'home-basic' || value == 'bodyweight' || value == 'none';
    }

    function isExperienceValue(value) {
      return value == 'beginner' || value == 'intermediate' || value == 'advanced';
    }

    function isDietValue(value) {
      return value == 'balanced' || value == 'low-carb' || value == 'vegetarian' || value == 'vegan' || value == 'keto';
    }

    function isValidOnboardingMap(data) {
      return data is map
        && data.keys().hasOnly(onboardingFieldKeys())
        && (!data.keys().hasAny(['age']) || (data.age is int && data.age >= 13 && data.age <= 100))
        && (!data.keys().hasAny(['sex']) || isSexValue(data.sex))
        && (!data.keys().hasAny(['height']) || (data.height is number && data.height >= 90 && data.height <= 260))
        && (!data.keys().hasAny(['goal']) || isGoalValue(data.goal))
        && (!data.keys().hasAny(['timeline']) || (data.timeline is int && data.timeline >= 1 && data.timeline <= 36))
        && (!data.keys().hasAny(['equipment']) || isEquipmentValue(data.equipment))
        && (!data.keys().hasAny(['experience']) || isExperienceValue(data.experience))
        && (!data.keys().hasAny(['diet']) || isDietValue(data.diet))
        && (!data.keys().hasAny(['injuries']) || data.injuries is string)
        && (!data.keys().hasAny(['activities']) || data.activities is string)
        && (!data.keys().hasAny(['likes']) || data.likes is string)
        && (!data.keys().hasAny(['notifications']) || data.notifications is bool)
        && (!data.keys().hasAny(['completedAt']) || data.completedAt is timestamp)
        && (!data.keys().hasAny(['version']) || data.version is int);
    }

    function isValidOnboardingMetaWrite() {
      let incomingKeys = request.resource.data.keys();
      let changedKeys = exists(resource.name)
        ? request.resource.data.diff(resource.data).changedKeys()
        : incomingKeys;
      return (
        (!changedKeys.hasAny(['completed']) ||
          !incomingKeys.hasAny(['completed']) ||
          request.resource.data.completed is bool)
        && (!changedKeys.hasAny(['completedAt']) ||
          !incomingKeys.hasAny(['completedAt']) ||
          request.resource.data.completedAt is timestamp)
        && (!changedKeys.hasAny(['updatedAt']) ||
          !incomingKeys.hasAny(['updatedAt']) ||
          request.resource.data.updatedAt is timestamp)
        && (!changedKeys.hasAny(['startedAt']) ||
          !incomingKeys.hasAny(['startedAt']) ||
          request.resource.data.startedAt is timestamp)
        && (!changedKeys.hasAny(['draftVersion']) ||
          !incomingKeys.hasAny(['draftVersion']) ||
          request.resource.data.draftVersion is int)
        && (!changedKeys.hasAny(['version']) ||
          !incomingKeys.hasAny(['version']) ||
          request.resource.data.version is int)
        && (!changedKeys.hasAny(['step']) ||
          !incomingKeys.hasAny(['step']) ||
          (request.resource.data.step is int && request.resource.data.step >= 0 && request.resource.data.step <= 4))
        && (!changedKeys.hasAny(['draft']) ||
          !incomingKeys.hasAny(['draft']) ||
          isValidOnboardingMap(request.resource.data.draft));
    }

    function onboardingFieldChanged() {
      if (!request.resource.data.keys().hasAny(['onboarding'])) {
        return false;
      }
      if (!exists(resource.name)) {
        return true;
      }
      return request.resource.data.diff(resource.data).changedKeys().hasAny(['onboarding']);
    }

    function isValidOnboardingUpdate() {
      return !onboardingFieldChanged() || isValidOnboardingMap(request.resource.data.onboarding);
    }

    match /publicConfig/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /app/publicConfig {
      allow read: if true;
      allow write: if false;
    }

    match /app/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if !isDemoUser() && isOwner(uid) && !isWritingServerOwnedFields() && isValidOnboardingUpdate();
      allow update: if !isDemoUser() && isOwner(uid) && !isWritingServerOwnedFields() && isValidOnboardingUpdate();
      allow delete: if false;

      match /scans/{scanId} {
        allow create: if !isDemoUser() && isOwner(uid)
          && request.resource.data.keys().hasOnly(['createdAt','notes','status'])
          && request.resource.data.status == 'queued';

        allow update: if !isDemoUser() && isOwner(uid)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['notes']);

        allow read: if isOwner(uid);
        allow write: if false;
      }

      match /private/{doc=**} {
        allow read: if isOwner(uid);
        allow write: if false;
      }

      match /coach/{sub=**} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid) && !request.resource.id.matches('plan(/.*)?');
      }

      match /coach/plan/{rest=**} {
        allow read: if isOwner(uid);
        allow write: if false;
      }

      match /coachPlans/current {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /profile/{docId} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /settings/{docId} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /preferences/{docId} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /workoutPlans/{planId} {
        allow read: if isOwner(uid);
        allow write: if false;

        match /progress/{day} {
          allow read: if isOwner(uid);
          allow write: if false;
        }
      }

      match /nutritionLogs/{day} {
        allow read: if isOwner(uid);
        allow create: if !isDemoUser() && isOwner(uid);
        allow update: if !isDemoUser() && isOwner(uid)
          && request.resource.data.calories is int
          && request.resource.data.calories >= 0
          && request.resource.data.calories <= 10000;
        allow delete: if false;

        match /entries/{entryId} {
          allow read: if isOwner(uid);
          allow create: if !isDemoUser() && isOwner(uid);
          allow update: if !isDemoUser() && isOwner(uid);
          allow delete: if !isDemoUser() && isOwner(uid);
        }
      }

      match /healthDaily/{day} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /nutrition/{docId} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);

        match /{sub=**} {
          allow read: if isOwner(uid);
          allow write: if !isDemoUser() && isOwner(uid);
        }
      }

      match /nutritionFavorites/{docId} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /nutritionTemplates/{docId} {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid);
      }

      match /meta/onboarding {
        allow read: if isOwner(uid);
        allow write: if !isDemoUser() && isOwner(uid) && isValidOnboardingMetaWrite();
      }

      match /meta/{docId} {
        allow read: if docId != "onboarding" && isOwner(uid);
        allow write: if false;
      }
    }

    match /stripeEvents/{eventId} {
      allow read: if request.auth != null && request.auth.token.staff == true;
      allow write: if false;
    }

    match /telemetryEvents/{eventId} {
      allow read: if request.auth != null && request.auth.token.staff == true;
      allow write: if false;
    }
  }
}
