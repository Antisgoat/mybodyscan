rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isStaff() {
      return request.auth != null && request.auth.token.staff == true;
    }

    function isDemoByClaim() {
      return isSignedIn() && request.auth.token.demo == true;
    }

    function isDemoByUid() {
      return isSignedIn() && request.auth.uid == "DEMO_UID_REPLACE_ME";
    }

    function isDemoUser() {
      return isDemoByClaim() || isDemoByUid();
    }

    function serverOwnedKeys() {
      return ['credits', 'stripe', 'plan', 'subscription', 'role', 'claims', 'stripeCustomerId'];
    }

    function isWritingServerOwnedFields() {
      return !clientPreservesServerFields();
    }

    function clientPreservesServerFields() {
      return (
        !request.resource.data.keys().hasAny(serverOwnedKeys()) &&
        (
          !exists(resource.name) ||
          !request.resource.data.diff(resource.data).changedKeys().hasAny(serverOwnedKeys())
        )
      );
    }

    function isNumber(value) {
      return value is int || value is float;
    }

    function optionalNumberField(data, field, min, max) {
      return !(field in data) || (isNumber(data[field]) && data[field] >= min && data[field] <= max);
    }

    function validNutritionTotals(totals) {
      return totals is map &&
        totals.keys().hasOnly(['calories', 'protein', 'carbs', 'fat', 'alcohol']) &&
        optionalNumberField(totals, 'calories', 0, 20000) &&
        optionalNumberField(totals, 'protein', 0, 2000) &&
        optionalNumberField(totals, 'carbs', 0, 2000) &&
        optionalNumberField(totals, 'fat', 0, 2000) &&
        optionalNumberField(totals, 'alcohol', 0, 2000);
    }

    function validNutritionLog(dateId) {
      let data = request.resource.data;
      return dateId.matches('^\\d{4}-\\d{2}-\\d{2}$') &&
        data.keys().hasOnly(['calories', 'protein_g', 'carbs_g', 'fat_g', 'alcohol', 'meals', 'totals', 'updatedAt']) &&
        optionalNumberField(data, 'calories', 0, 20000) &&
        optionalNumberField(data, 'protein_g', 0, 2000) &&
        optionalNumberField(data, 'carbs_g', 0, 2000) &&
        optionalNumberField(data, 'fat_g', 0, 2000) &&
        optionalNumberField(data, 'alcohol', 0, 2000) &&
        (!('updatedAt' in data) || data.updatedAt is timestamp) &&
        (!('meals' in data) || (data.meals is list && data.meals.size() <= 200)) &&
        (!('totals' in data) || validNutritionTotals(data.totals));
    }

    function onboardingFieldKeys() {
      return ['age', 'sex', 'height', 'goal', 'timeline', 'equipment', 'injuries', 'activities', 'experience', 'diet', 'likes', 'notifications', 'completedAt', 'version'];
    }

    function isSexValue(value) {
      return value == 'male' || value == 'female' || value == 'other';
    }

    function isGoalValue(value) {
      return value == 'lose-fat' || value == 'gain-muscle' || value == 'maintain' || value == 'recomp';
    }

    function isEquipmentValue(value) {
      return value == 'gym' || value == 'home-basic' || value == 'bodyweight' || value == 'none';
    }

    function isExperienceValue(value) {
      return value == 'beginner' || value == 'intermediate' || value == 'advanced';
    }

    function isDietValue(value) {
      return value == 'balanced' || value == 'low-carb' || value == 'vegetarian' || value == 'vegan' || value == 'keto';
    }

    function isValidOnboardingMap(data) {
      return data is map &&
        data.keys().hasOnly(onboardingFieldKeys()) &&
        (!data.keys().hasAny(['age']) || (data.age is int && data.age >= 13 && data.age <= 100)) &&
        (!data.keys().hasAny(['sex']) || isSexValue(data.sex)) &&
        (!data.keys().hasAny(['height']) || (data.height is number && data.height >= 90 && data.height <= 260)) &&
        (!data.keys().hasAny(['goal']) || isGoalValue(data.goal)) &&
        (!data.keys().hasAny(['timeline']) || (data.timeline is int && data.timeline >= 1 && data.timeline <= 36)) &&
        (!data.keys().hasAny(['equipment']) || isEquipmentValue(data.equipment)) &&
        (!data.keys().hasAny(['experience']) || isExperienceValue(data.experience)) &&
        (!data.keys().hasAny(['diet']) || isDietValue(data.diet)) &&
        (!data.keys().hasAny(['injuries']) || data.injuries is string) &&
        (!data.keys().hasAny(['activities']) || data.activities is string) &&
        (!data.keys().hasAny(['likes']) || data.likes is string) &&
        (!data.keys().hasAny(['notifications']) || data.notifications is bool) &&
        (!data.keys().hasAny(['completedAt']) || data.completedAt is timestamp) &&
        (!data.keys().hasAny(['version']) || data.version is int);
    }

    function isValidOnboardingMetaWrite() {
      let incomingKeys = request.resource.data.keys();
      let changedKeys = exists(resource.name)
        ? request.resource.data.diff(resource.data).changedKeys()
        : incomingKeys;
      return (
        (!changedKeys.hasAny(['completed']) ||
          !incomingKeys.hasAny(['completed']) ||
          request.resource.data.completed is bool) &&
        (!changedKeys.hasAny(['completedAt']) ||
          !incomingKeys.hasAny(['completedAt']) ||
          request.resource.data.completedAt is timestamp) &&
        (!changedKeys.hasAny(['updatedAt']) ||
          !incomingKeys.hasAny(['updatedAt']) ||
          request.resource.data.updatedAt is timestamp) &&
        (!changedKeys.hasAny(['startedAt']) ||
          !incomingKeys.hasAny(['startedAt']) ||
          request.resource.data.startedAt is timestamp) &&
        (!changedKeys.hasAny(['draftVersion']) ||
          !incomingKeys.hasAny(['draftVersion']) ||
          request.resource.data.draftVersion is int) &&
        (!changedKeys.hasAny(['version']) ||
          !incomingKeys.hasAny(['version']) ||
          request.resource.data.version is int) &&
        (!changedKeys.hasAny(['step']) ||
          !incomingKeys.hasAny(['step']) ||
          (request.resource.data.step is int && request.resource.data.step >= 0 && request.resource.data.step <= 4)) &&
        (!changedKeys.hasAny(['draft']) ||
          !incomingKeys.hasAny(['draft']) ||
          isValidOnboardingMap(request.resource.data.draft))
      );
    }

    function onboardingFieldChanged() {
      if (!request.resource.data.keys().hasAny(['onboarding'])) {
        return false;
      }
      if (!exists(resource.name)) {
        return true;
      }
      return request.resource.data.diff(resource.data).changedKeys().hasAny(['onboarding']);
    }

    function isValidOnboardingUpdate() {
      return !onboardingFieldChanged() || isValidOnboardingMap(request.resource.data.onboarding);
    }

    match /app/publicConfig {
      allow read: if true;
      allow write: if false;
    }

    match /events/telemetry/{eventId} {
      allow create: if isSignedIn();
      allow read: if isStaff();
      allow update, delete: if false;
    }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid) && !isWritingServerOwnedFields() && isValidOnboardingUpdate();
      allow update: if isOwner(uid) && !isWritingServerOwnedFields() && isValidOnboardingUpdate();
      allow delete: if false;

      match /scans/{scanId} {
        allow read: if isOwner(uid) || isStaff();
        allow write: if false;
      }

      match /private/{document=**} {
        allow read: if isOwner(uid);
        allow write: if false;
      }

      match /coachPlans/{docId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && docId == 'current';
        allow delete: if false;
      }

      match /coach/{document=**} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid);
        allow delete: if false;
      }

      match /nutritionLogs/{dateId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && clientPreservesServerFields() && validNutritionLog(dateId);
        allow delete: if false;
      }

      match /meta/onboarding {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid) && isValidOnboardingMetaWrite();
      }

      match /{document=**} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && clientPreservesServerFields();
        allow delete: if false;
      }
    }

    match /stripe_events/{eventId} {
      allow read, write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
