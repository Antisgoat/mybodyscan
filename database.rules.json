rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Server-owned field protection helper
    function disallowServerOwnedWrites() {
      return !(('credits' in request.resource.data) ||
               ('stripe' in request.resource.data) ||
               ('plan' in request.resource.data) ||
               ('subscription' in request.resource.data) ||
               ('role' in request.resource.data) ||
               ('stripeCustomerId' in request.resource.data));
    }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) && disallowServerOwnedWrites();
      allow delete: if false;

      // Scans
      match /scans/{scanId} {
        // Client can create a minimal queued doc (no server fields)
        allow create: if isOwner(uid)
          && request.resource.data.keys().hasOnly(['createdAt','notes','status'])
          && request.resource.data.status == 'queued';

        // Client may update notes only
        allow update: if isOwner(uid)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['notes']);

        // Read own scans
        allow read: if isOwner(uid);

        // Server-only writes for results/status/completedAt/error
        allow write: if false;
      }

      // Coach profile: user can write; plan is server-only
      match /coach/{sub=**} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid) && !request.resource.id.matches('plan(/.*)?');
      }

      // Current plan is server-only
      match /coach/plan/{rest=**} {
        allow read: if isOwner(uid);
        allow write: if false;
      }

      // Nutrition logs
      match /nutritionLogs/{day} {
        allow read, create: if isOwner(uid);
        allow update: if isOwner(uid)
          && request.resource.data.calories is int
          && request.resource.data.calories >= 0
          && request.resource.data.calories <= 10000;
        allow delete: if false;
      }

      // Health daily entries
      match /healthDaily/{day} {
        allow read, write: if isOwner(uid);
      }
    }

    // Stripe events collection is server-only
    match /stripe_events/{eventId} {
      allow read, write: if false;
    }
  }
}
